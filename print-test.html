<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>QZ Tray - In thẻ DIV</title>

  <!-- Thư viện QZ Tray -->
  <script src="scripts/lib/qz-tray.js"></script>

  <!-- Thư viện jsrsasign để ký số -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.25/jsrsasign-all-min.js"></script>

  <style>
    #printArea { border:1px solid #999; padding:16px; width:600px; font-family:Arial; }
    #printArea h2 { margin:0 0 8px; }
    #printArea p  { margin:4px 0; line-height:1.4; }
  </style>
</head>
<body>
  <button id="btnConnect">Kết nối QZ</button>
  <button id="btnList">Liệt kê máy in</button>
  <select id="printerSelect"></select>
  <button id="btnPrint">In thẻ DIV</button>

  <div id="printArea">
    <h2>Hóa đơn mẫu</h2>
    <p>Khách hàng: Nguyễn Văn A</p>
    <p>Ngày: 29/08/2025</p>
    <p>Mặt hàng: Sản phẩm ABC x 2</p>
    <p>Tổng: 123.456 đ</p>
  </div>

<script>
  // Chứng chỉ số (self-signed)
  qz.security.setCertificatePromise(function(resolve, reject) {
    resolve(`-----BEGIN CERTIFICATE-----
MIID1TCCAr2gAwIBAgIUd71nkscTcLdc3xqXP1JJNK88G7wwDQYJKoZIhvcNAQEL
BQAwejELMAkGA1UEBhMCVk4xCzAJBgNVBAgMAkhOMQswCQYDVQQHDAJITjEQMA4G
A1UECgwHUVogVGVzdDEMMAoGA1UECwwDRGV2MRIwEAYDVQQDDAlsb2NhbGhvc3Qx
HTAbBgkqhkiG9w0BCQEWDnlvdXJAZW1haWwuY29tMB4XDTI1MDgyOTA4MzEwM1oX
DTI2MDgyOTA4MzEwM1owejELMAkGA1UEBhMCVk4xCzAJBgNVBAgMAkhOMQswCQYD
VQQHDAJITjEQMA4GA1UECgwHUVogVGVzdDEMMAoGA1UECwwDRGV2MRIwEAYDVQQD
DAlsb2NhbGhvc3QxHTAbBgkqhkiG9w0BCQEWDnlvdXJAZW1haWwuY29tMIIBIjAN
BgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1YCj4VtYpxlyxfPJ+wMq3MX0dTLL
8cnrc5vtUorTD/gaABx8rQDNmzlTvpYKzPssUd/2SVrXmZA2mH8KG5giHjl+255k
akcrZ0py7YP/w8nijRrf5/SicLe4G5pbxdfZIk7nhk0fqdQLYPl8eonFxUAwW6f5
ClS07HYDfMLzUWgRJxHupykfhxiI14bChiNnQMFRhWs5WoVLpA3PeRYp5DL+aYNw
oeGm8fxI5nkC2Grr4OQpkcO4GP2uoIRpbja2J+8cV8PENyrH1KpKp0twBZvfVmCc
ANv4PhKAazJjIjyqX803YQg0JYw2IjuO90bwY2293HWLDu+2hfemaPxFzQIDAQAB
o1MwUTAdBgNVHQ4EFgQUcg13yEaHWpvOxExerEl+EiN4eCMwHwYDVR0jBBgwFoAU
cg13yEaHWpvOxExerEl+EiN4eCMwDwYDVR0TAQH/BAUwAwEB/zANBgkqhkiG9w0B
AQsFAAOCAQEAnuVjNMr/WidGrH4846PgzhOvheYtB6StEhA9msHEZFZ6b2S4vnvS
0e+LyDU4n/pyKKJFEUPA4cxCzQymRVkVpKZcBjuWjW/1RZd5BcGQgcBeIBOu77IV
ok70+dSq2L8Am6Kff+sMOo465zPVj40vvfhd0xByO3rYIxQGfEitd9P67r3OydFY
ENf4XjaeKS4NsyfryM//s7IFK5Poi+4gsCksRLfGAXmyJ3gz1CPOwo0pkrnkcC7V
tNhkA//bOpRaKbk3ZbD4pBcLYJQfefP61feW2o8lqJLMRgtFB1141c1N03OBHCth
ykmCSbW+05Nrt3JGiGE44i2Qc6icynGXSQ==
-----END CERTIFICATE-----`);
  });

  // Ký số với private key
  qz.security.setSignaturePromise(function(toSign) {
    return function(resolve, reject) {
      const privateKey = `-----BEGIN PRIVATE KEY-----
MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQDVgKPhW1inGXLF
88n7AyrcxfR1Msvxyetzm+1SitMP+BoAHHytAM2bOVO+lgrM+yxR3/ZJWteZkDaY
fwobmCIeOX7bnmRqRytnSnLtg//DyeKNGt/n9KJwt7gbmlvF19kiTueGTR+p1Atg
+Xx6icXFQDBbp/kKVLTsdgN8wvNRaBEnEe6nKR+HGIjXhsKGI2dAwVGFazlahUuk
Dc95FinkMv5pg3Ch4abx/EjmeQLYauvg5CmRw7gY/a6ghGluNrYn7xxXw8Q3KsfU
qkqnS3AFm99WYJwA2/g+EoBrMmMiPKpfzTdhCDQljDYiO473RvBjbb3cdYsO77aF
96Zo/EXNAgMBAAECggEARWQ4n3O1hiX+yDjawnM+mJ/cOsVGRPFITfx1b3kAbXXJ
WZTorsAOk29X+R9CJmpSds/wd9oHLfmRzRGpQtu45xLv2MiLwYEdKcaoQOtAky2I
LS15baX0r+b+dzY9srlbcMutc1iYvHVXN28PFrK1rU0WCow3JLTwUtRugLvKIoA0
6XA7JtJwxRAdNgAJmROPOUFWO8BaMPEsSGhzLs9CG11JDdUTu252a8kzMP3P+mQn
dVZKBGvGoxzNhn1OHS79dDY/CyxpfFLpQoWql7BB9UkYDiC4BquXXa26WGYC62Jr
MqT1RWgs/Zq5FKntWzrbNo0xhrQkr7FzcuyVNeYYvwKBgQDtiAE9LU4Syt/P1uZe
oflubfwyhVpg/jhP0IRHAMv9333KNX6UocDni9I7j7kqRqCuXq+cI6IHZQ06XffT
jHfeXI5u+P5HqZUlpWy4B735wONWy49nYyxB+YnxHrZHEQ0ByHpjAg7PfGHT8sP3
f3Orl7bZxn45vLtKIKKCjwCR0wKBgQDmGllncoqSoh5pL60LZEXyijUlSO1KBBSg
UpBe2kuXVH/7IceCm1gvS1fx7CCTxGRtaI+TiHd0G2IZcdaFo5KSN4kj86CHGjty
GvdY5/pUbIBd6PRuDb7UsHVamiZp913KYui1DvSnNC/cm3D1DFde6DSUWCTWy2RC
50nH7Bdl3wKBgEKQwLgiQCToEbyvHrQadEpMLEcENAXGeIV1i/xR7tjgjuHiB+0j
P2okNvBWILAGRvVWt6PsIHYuDXzz5IW2cckw6wGSacAveAqqx0LzeHvLYGpsdW2l
zztV8SBPWQmlb522TwX8B6aB1vCMsfpkD0hhJe71v13y1BG7/47TAHfdAoGACQxG
MbQmUMfBLF+sjUMfIP9gQZwRgJSSfw9gD+rDiCrRcX2Ni8wx9oIe7itbyJOzYz32
T1XRZKZjAB8i0VRyQf+fC+PbjxRv+/elfEB67nDpx0eOvPkbZN+fbbWcBxSsAnZL
MjtpUV3S9/jAw1H96YR19NNWd3+97IeNtifJb78CgYBmXSS5Sc5O7CloN5+RQDUq
3ZZJYP5jA6Q/x/klF3KI9xNuiSdhzRqiFnL4xm34Q3cB9v4Xl7gGqeME9xQRVKw5
ueKcZxeVaSfy+JRLhBCJa7QBnqV97gL+OjQHtpdZ2VDNQsyFFJ4+v/9rz+kYyHrx
BYDDxqikLlXPbuybFilxLQ==
-----END PRIVATE KEY-----`;
 

      try {
        const sig = new KJUR.crypto.Signature({ alg: "SHA512withRSA" });
        sig.init(privateKey);
        sig.updateString(toSign);
        const hex = sig.sign();
        resolve(hex);
      } catch (err) {
        console.error("Ký số thất bại:", err);
        reject(err);
      }
    };
  });

  // Kết nối QZ
  async function connectQZ() {
    if (qz.websocket.isActive()) return;
    await qz.websocket.connect();
    console.log("QZ connected");
  }

  // Liệt kê máy in
  async function listPrinters() {
    await connectQZ();
    const printers = await qz.printers.find();
    const sel = document.getElementById('printerSelect');
    sel.innerHTML = "";
    printers.forEach(name => {
      const opt = document.createElement('option');
      opt.value = opt.textContent = name;
      sel.appendChild(opt);
    });
    console.log("Printers:", printers);
  }

  // Lấy HTML từ thẻ DIV
  function buildHtmlFromDiv(divId) {
    const el = document.getElementById(divId);
    return `
      <!doctype html>
      <html><head><meta charset="utf-8"></head>
      <body>${el.outerHTML}</body></html>`;
  }

  // In
  async function printDiv() {
    await connectQZ();
    const printer = document.getElementById('printerSelect').value || null;
    const config = qz.configs.create(printer, {
      units: 'mm',
      size: { width: 210, height: 297 },
      margins: { top: 0, right: 0, bottom: 0, left: 0 },
      jobName: "In the DIV - Demo"
    });
    const htmlDoc = buildHtmlFromDiv('printArea');

    const data = [{
      type: 'pixel',
      format: 'html',
      flavor: 'plain',
      data: htmlDoc,
      options: { pageWidth: 210, pageHeight: 297, units: 'mm' }
    }];

    await qz.print(config, data);
    console.log("Sent to printer");
  }

  // Gán nút
  document.getElementById('btnConnect').onclick = connectQZ;
  document.getElementById('btnList').onclick = listPrinters;
  document.getElementById('btnPrint').onclick = printDiv;
</script>
</body>
</html>
